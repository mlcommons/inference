Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export TZ=US/Pacific
    export DEBIAN_FRONTEND=noninteractive
    export PATH=$PATH:/opt/miniconda3/bin

%post
    # Use bash
    SHELL=/bin/bash

    echo "Setting timezone..."
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

    echo "Cleaning apt lists and sources..."
    rm -rf /var/lib/apt/lists/* && rm -f /etc/apt/sources.list.d/*

    echo "Updating apt and installing base packages..."
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential autoconf libtool git ccache curl wget pkg-config \
        sudo ca-certificates automake libssl-dev bc python3-dev python3-pip \
        google-perftools gdb libglib2.0-dev clang sshfs libre2-dev libboost-dev \
        libnuma-dev numactl sysstat sshpass ntpdate less iputils-ping rsync \
        pkg-config zip g++ zlib1g-dev unzip libarchive-dev

    # Remove unneeded packages
    apt-get -y autoremove
    apt-get remove -y cmake

    echo "Upgrading pip and setuptools..."
    python3 -m pip install --upgrade pip setuptools wheel virtualenv

    echo "Installing Miniconda..."
    cd /tmp
    wget https://repo.anaconda.com/miniconda/Miniconda3-py310_23.5.2-0-Linux-x86_64.sh
    bash Miniconda3-py310_23.5.2-0-Linux-x86_64.sh -b -p /opt/miniconda3
    chmod -R 777 /opt/miniconda3

    echo "Creating conda environment llama2-70b..."
    /opt/miniconda3/bin/conda create -n llama2-70b python=3.10

%runscript
    echo "Container built successfully. Use '--nv' for GPU support."
    exec "$@"

